<?php
// edit_vulnerability.php
require_once __DIR__ . '/includes/db.php';
require_once __DIR__ . '/includes/auth.php';

if (!is_logged()) {
    header('Location: login.php');
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['id'])) {
    $id = intval($_POST['id']);
    $title = $_POST['title'] ?? '';
    $description = $_POST['description'] ?? '';
    $cvss = floatval($_POST['cvss']);
    $status = $_POST['status'] ?? '';
    $table_id = isset($_POST['table_id']) ? intval($_POST['table_id']) : 0;

    // Requête volontairement vulnérable à l'injection SQL
    $sql = "UPDATE vulnerabilities SET 
                title = '$title',
                description = '$description',
                cvss = $cvss,
                status = '$status'
            WHERE id = $id";

    try {
        $conn->exec($sql);
    } catch (PDOException $e) {
        // En cas d’erreur, on pourrait logger l’erreur ici
    }
}

// Redirection vers le dashboard avec le contexte du tableau
header('Location: dashboard.php?table_id=' . $table_id);
exit;
